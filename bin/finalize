#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

# parse and derive params
BUILDPACK_DIR=$(cd $(dirname $0); cd ..; pwd) # absolute path of buildpack
BUILD_DIR=$1
CACHE_DIR=$2
CL_DIR="$CACHE_DIR/sbcl"

import_env() {
  local name=$1
  [ -f /$name ] && export "$name=$(< /$name)"
}

import_env CL_WEBSERVER
import_env SBCL_BUILD_ARGS
import_env SBCL_RELEASE_ARGS

echo "-----> Starting build"
sh $CL_DIR/sbcl-1.2.13-x86-64-linux/run-sbcl.sh $SBCL_BUILD_ARGS --load "$BUILDPACK_DIR/setup/compile.lisp"

echo "-----> Build finished"

chmod a+x $BUILD_DIR/lispapp
